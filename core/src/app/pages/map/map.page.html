<ion-content scrollY="false">
  <wm-geobox-map #geoboxMap>
    <wm-map-details #details (closeEVT)="close()">
      <div header>
        <div class="webmapp-info-header-container">
          <ng-container *ngIf="poiProperties$|async as properties">
            <div class="webmapp-pagepoi-info-header">
              <ng-container *ngIf="properties?.taxonomy.poi_types as poiTypes;else poiTypeTemplate">
                <ng-container *ngFor="let poiType of poiTypes">
                  <div class="webmapp-pagepoi-info-header-pre-title">{{ poiType.name|wmtrans}}</div>
                </ng-container>
              </ng-container>
              <ng-template #poiTypeTemplate>
                <div
                  class="webmapp-pagepoi-info-header-pre-title"
                  *ngIf="properties?.taxonomy.poi_type as poiType"
                >
                  {{ poiType.name|wmtrans}}
                </div>
              </ng-template>
              <div class="webmapp-pagepoi-info-header-title" *ngIf="properties?.name as name">
                {{name|wmtrans}}
              </div>

              <div class="webmapp-pagepoi-info-header-arrows" *ngIf="properties?.isRelated">
                <div class="ripple-parent ion-activatable webmapp-pagepoi-info-header-arrow">
                  <i class="icon-outline-arrow-left" (click)="poiPrev()"></i>
                  <ion-ripple-effect></ion-ripple-effect>
                </div>
                <div class="ripple-parent ion-activatable webmapp-pagepoi-info-header-arrow">
                  <i
                    class="icon-outline-arrow-right webmapp-pagepoi-info-header-arrow-icon"
                    (click)="poiNext()"
                  ></i>
                  <ion-ripple-effect></ion-ripple-effect>
                </div>
              </div>
            </div>
          </ng-container>
          <ion-title *ngIf="!(poiProperties$|async) && currentTrack$|async as currentTrack;">
            {{currentTrack?.properties?.name|wmtrans }}
          </ion-title>
        </div>
      </div>

      <wm-inner-component-html
        *ngIf="popup$|async as popup"
        [html]="popup.html"
        [enableDismiss]="false"
      ></wm-inner-component-html>
      <ng-container *ngIf="poiProperties$|async as properties;else track">
        <ion-content class="webmapp-pagepoi-info-body" scrollY="true">
          <wm-poi-properties [properties]="properties"></wm-poi-properties>
        </ion-content>
      </ng-container>
      <ng-template #track>
        <wm-track-properties
          (trackElevationChartHover)="setTrackElevationChartHoverElements($event)"
          (dismiss)="updateEcTrack()"
          (click)="savePosition()"
          class="webmapp-track-details"
        >
          <ng-container *ngIf="(confOPTIONS$|async) as opt">
            <ion-item
              *ngIf="opt.print_track_enable != null && opt.print_track_enable === true"
              [href]="'https://geohub.webmapp.it/track/pdf/'+ecTrack.properties.id+'/?app_id='+(geohubId$|async)"
              class="webmapp-track-download-urls-item"
              target="_blank"
            >
              <ion-icon class="wm-icn icon-link" slot="start"></ion-icon>
              <ion-label class="webmapp-track-download-urls-item-label">
                {{"apri pdf"|wmtrans}}
              </ion-label>
            </ion-item>
          </ng-container>
        </wm-track-properties>
      </ng-template>

      <wm-ugc-details
        *ngIf="(ugcTrack$|async) as ugcTrack"
        [track]="ugcTrack"
        (trackElevationChartHover)="setTrackElevationChartHoverElements($event)"
        (poi-click)="setCurrentRelatedPoi($event)"
        class="webmapp-track-details"
      ></wm-ugc-details>

      <ng-template #skeleton>
        <ion-skeleton-text [animated]="true" style="height:100%;width: 100%"></ion-skeleton-text>
      </ng-template>
    </wm-map-details>
    <div bottom-right>
      <ion-fab
        #fab2
        slot="fixed"
        vertical="top"
        horizontal="start"
        (click)="fab1?.close();fab3?.close()"
        *ngIf="(currentTrack$|async)!= null"
      >
        <ion-fab-button>
          <ion-icon name="locate-outline"></ion-icon>
        </ion-fab-button>
        <ion-fab-list side="start">
          <wm-btn-orientation
            class="webmapp-map-fab"
            [degrees]="geoboxMap.mapCmp.mapDegrees"
            (click)="geoboxMap.mapCmp.orientNorth()"
          >
          </wm-btn-orientation>
          <ion-fab-button (click)="navigation()">
            <ion-icon name="navigate-outline"></ion-icon>
          </ion-fab-button>
          <wm-btn-center-position
            *ngIf="false"
            (click)="centerPositionEvt$.next((!centerPositionEvt$.value)||false)"
          ></wm-btn-center-position>
        </ion-fab-list>
      </ion-fab>
      <ion-fab
        slot="fixed"
        vertical="top"
        horizontal="start"
        #fab3
        *ngIf="isTrackRecordingEnable$|async"
        (click)="fab2?.close();fab1?.close()"
      >
        <ion-fab-button size="small" class="wm-btn-register-fab">
          <i class="icon-outline-recording"></i>
        </ion-fab-button>
        <wm-btn-track-recording
          [isLogged]="isLogged$|async"
          (start-recording)="startRecording$.next($event)"
        ></wm-btn-track-recording>
      </ion-fab>
    </div>
  </wm-geobox-map>

  <ng-template #offline>
    <wm-map
      #wmap
      [wmMapConf]="confMap$|async"
      wmMapPosition
      [wmMapPositioncurrentLocation]="currentPosition$|async"
      [wmMapPositionCenter]="centerPositionEvt$|async"
      [wmMapPositionfocus]="wmMapPositionfocus$|async"
      wmMapTrack
      [track]="currentTrack$|async"
      [wmMapTrackColor]="trackColor$|async"
      [trackElevationChartElements]="trackElevationChartHoverElements$|async"
      wmMapTrackRelatedPois
      (related-poi-next)="currentPoiNextID$.next(+$event)"
      (wmMapTrackRelatedPoisNearestPoiEvt)="nearestPoi$.next($event)"
      (related-poi)="setCurrentRelatedPoi($event)"
    >
      <div bottom-right>
        <ion-fab
          #fab2
          slot="fixed"
          vertical="top"
          horizontal="start"
          (click)="fab1?.close();fab3?.close()"
          *ngIf="(trackid$|async)!= null"
        >
          <ion-fab-button>
            <ion-icon name="locate-outline"></ion-icon>
          </ion-fab-button>
          <ion-fab-list side="start">
            <wm-btn-orientation
              *ngIf="(trackid$|async)!= null"
              class="webmapp-map-fab"
              [degrees]="wmap.mapDegrees"
              (click)="wmap.orientNorth()"
            >
            </wm-btn-orientation>
            <ion-fab-button (click)="navigation()">
              <ion-icon name="navigate-outline"></ion-icon>
            </ion-fab-button>
            <wm-btn-center-position
              *ngIf="false"
              (click)="centerPositionEvt$.next((!centerPositionEvt$.value)||false)"
            ></wm-btn-center-position>
          </ion-fab-list>
        </ion-fab>
        <ion-fab
          slot="fixed"
          vertical="top"
          horizontal="start"
          #fab3
          *ngIf="isTrackRecordingEnable$|async"
          (click)="fab2?.close();fab1?.close()"
        >
          <ion-fab-button size="small" class="wm-btn-register-fab">
            <i class="icon-outline-recording"></i>
          </ion-fab-button>
          <wm-btn-track-recording
            [isLogged]="isLogged$|async"
            (start-recording)="startRecording$.next($event)"
          ></wm-btn-track-recording>
        </ion-fab>
      </div>
    </wm-map>
  </ng-template>

  <wm-download
    *ngIf="showDownload$|async"
    [track]="currentTrack$|async"
    (closeEvt)="showDownload$.next(false);mapDetailsCmp.open()"
    (goToEvt)="goToPage($event)"
  ></wm-download>
</ion-content>
